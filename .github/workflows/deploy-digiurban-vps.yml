name: Deploy DigiUrban to VPS

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_PASSWORD }}" > ~/.ssh/vps_password
          chmod 600 ~/.ssh/vps_password

      - name: Sync code to VPS
        run: |
          # Instalar sshpass para autentica√ß√£o com senha
          sudo apt-get update && sudo apt-get install -y sshpass rsync

          # Criar diret√≥rio no VPS
          sshpass -f ~/.ssh/vps_password ssh -o StrictHostKeyChecking=no root@digiurban.com.br "mkdir -p /root/digiurban"

          # Sincronizar c√≥digo via rsync
          sshpass -f ~/.ssh/vps_password rsync -avz --delete \
            --exclude='.git' \
            --exclude='node_modules' \
            --exclude='.next' \
            --exclude='dist' \
            --exclude='*.db' \
            --exclude='*.db-*' \
            -e "ssh -o StrictHostKeyChecking=no" \
            ./ root@digiurban.com.br:/root/digiurban/

      - name: Deploy to VPS
        uses: appleboy/ssh-action@master
        with:
          host: digiurban.com.br
          username: root
          password: ${{ secrets.VPS_PASSWORD }}
          port: 22
          timeout: 300s
          command_timeout: 300s
          script: |
            set -e

            echo "=== Iniciando Deploy DigiUrban ==="

            # Diret√≥rio da aplica√ß√£o
            APP_DIR="/root/digiurban"

            # Parar containers existentes
            echo "Parando containers existentes..."
            cd $APP_DIR
            docker-compose -f docker-compose.vps.yml down || true

            echo "Verificando c√≥digo sincronizado..."
            ls -la

            # Criar arquivo .env
            echo "Criando arquivo .env..."
            cat > .env << 'EOF'
            # Node.js
            NODE_ENV=production

            # Backend
            PORT=3001
            BACKEND_PORT=3001

            # Frontend
            FRONTEND_PORT=3000
            NEXT_PUBLIC_API_URL=http://localhost:3001

            # PostgreSQL (valores padr√£o)
            POSTGRES_USER=digiurban
            POSTGRES_PASSWORD=digiurban2024
            POSTGRES_DB=digiurban

            # Database URL (PostgreSQL)
            DATABASE_URL=postgresql://digiurban:digiurban2024@postgres:5432/digiurban

            # JWT (gerado automaticamente para produ√ß√£o)
            JWT_SECRET=digiurban-production-secret-$(date +%s)-$(openssl rand -hex 16)
            JWT_EXPIRES_IN=7d
            JWT_ADMIN_EXPIRES_IN=8h
            JWT_CITIZEN_EXPIRES_IN=30d

            # CORS
            FRONTEND_URL=https://www.digiurban.com.br
            CORS_ORIGIN=https://www.digiurban.com.br
            ALLOWED_ORIGINS=https://www.digiurban.com.br,http://www.digiurban.com.br,https://digiurban.com.br,http://digiurban.com.br,http://72.60.10.108:3060,http://localhost:3060

            # Tenants
            DEFAULT_TENANT=demo

            # Logs
            LOG_LEVEL=info
            EOF

            # Adicionar BUILD_TIMESTAMP ao .env
            echo "BUILD_TIMESTAMP=$(date +%s)" >> .env

            # Remover arquivos .db SQLite antigos (n√£o usamos mais)
            echo "Removendo arquivos .db do c√≥digo-fonte..."
            find . -name "*.db" -type f ! -path "*/node_modules/*" -delete || true
            find . -name "*.db-*" -type f ! -path "*/node_modules/*" -delete || true
            echo "‚úÖ Arquivos .db removidos"

            # Limpar containers e imagens antigas (PRESERVAR volumes do PostgreSQL)
            echo "Limpando recursos antigos..."
            docker container prune -f || true
            docker image prune -af || true

            # Garantir BUILD_TIMESTAMP como vari√°vel de ambiente ANTES do build
            export BUILD_TIMESTAMP=$(date +%s)
            echo "BUILD_TIMESTAMP=${BUILD_TIMESTAMP}"

            # Build da imagem sem cache (BUILD_TIMESTAMP vem do export acima)
            echo "Construindo nova imagem..."
            docker-compose -f docker-compose.vps.yml build --no-cache --pull

            # Iniciar container
            echo "Iniciando container..."
            docker-compose -f docker-compose.vps.yml up -d

            # Aguardar PostgreSQL e aplica√ß√£o iniciarem
            echo "Aguardando containers iniciarem..."
            sleep 30

            # Verificar status
            echo "Verificando status dos containers..."
            docker-compose -f docker-compose.vps.yml ps

            # Verificar logs do PostgreSQL
            echo "=== Logs do PostgreSQL ==="
            docker logs digiurban-postgres --tail=20

            # Verificar logs da aplica√ß√£o
            echo "=== Logs da Aplica√ß√£o ==="
            docker logs digiurban-vps --tail=100

            # Verificar se container est√° rodando
            if ! docker ps | grep -q digiurban-vps; then
              echo "‚ùå Container digiurban-vps n√£o est√° rodando!"
              echo "=== Logs completos do container ==="
              docker logs digiurban-vps
              exit 1
            fi

            # Verificar health
            echo "Verificando health check..."
            for i in {1..15}; do
              if curl -f http://localhost:3060/health; then
                echo "‚úÖ DigiUrban est√° rodando na porta 3060!"
                exit 0
              fi
              echo "Tentativa $i/15 falhou, aguardando 10s..."

              # Mostrar logs a cada 3 tentativas
              if [ $((i % 3)) -eq 0 ]; then
                echo "=== Logs recentes ==="
                docker logs digiurban-vps --tail=30
              fi

              sleep 10
            done

            echo "‚ö†Ô∏è Health check falhou ap√≥s 10 tentativas"
            echo "Logs completos:"
            docker-compose -f docker-compose.vps.yml logs
            exit 1

      - name: Verify Deployment
        if: success()
        run: |
          echo "‚úÖ Deploy conclu√≠do com sucesso!"
          echo "üåê DigiUrban dispon√≠vel em: https://www.digiurban.com.br"
          echo "üåê Acesso alternativo: http://72.60.10.108:3060"
          echo "üìä Health check: http://72.60.10.108:3060/health"
