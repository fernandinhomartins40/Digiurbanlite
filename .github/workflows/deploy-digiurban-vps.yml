name: Deploy DigiUrban to VPS

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to VPS
        uses: appleboy/ssh-action@master
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
        with:
          host: 72.60.10.108
          username: root
          password: ${{ secrets.VPS_PASSWORD }}
          port: 22
          timeout: 300s
          command_timeout: 300s
          envs: DATABASE_URL,JWT_SECRET
          script: |
            set -e

            echo "=== Iniciando Deploy DigiUrban ==="

            # DiretÃ³rio da aplicaÃ§Ã£o
            APP_DIR="/root/digiurban"

            # Criar diretÃ³rio se nÃ£o existir
            mkdir -p $APP_DIR
            cd $APP_DIR

            # Clonar ou atualizar repositÃ³rio
            if [ -d ".git" ]; then
              echo "Atualizando repositÃ³rio..."
              # Configurar git para usar HTTPS sem autenticaÃ§Ã£o (repositÃ³rio pÃºblico)
              git config --global credential.helper store
              git remote set-url origin https://github.com/fernandinhomartins40/Digiurbanlite.git
              git fetch origin
              git reset --hard origin/main
              git clean -fd
              echo "Verificando integridade do repositÃ³rio..."
              git status
              git log --oneline -5
            else
              echo "Clonando repositÃ³rio..."
              git clone https://github.com/fernandinhomartins40/Digiurbanlite.git .
            fi

            # Criar arquivo .env
            echo "Criando arquivo .env..."
            cat > .env << EOF
            # Node.js
            NODE_ENV=production

            # Backend
            PORT=3001
            BACKEND_PORT=3001

            # Frontend
            FRONTEND_PORT=3000
            NEXT_PUBLIC_API_URL=http://localhost:3001

            # Database
            DATABASE_URL=${DATABASE_URL}

            # JWT
            JWT_SECRET=${JWT_SECRET}
            JWT_EXPIRES_IN=7d
            JWT_ADMIN_EXPIRES_IN=8h
            JWT_CITIZEN_EXPIRES_IN=30d

            # CORS
            FRONTEND_URL=https://www.digiurban.com.br
            CORS_ORIGIN=https://www.digiurban.com.br
            ALLOWED_ORIGINS=https://www.digiurban.com.br,http://www.digiurban.com.br,https://digiurban.com.br,http://digiurban.com.br,http://72.60.10.108:3060,http://localhost:3060

            # Tenants
            DEFAULT_TENANT=demo

            # Logs
            LOG_LEVEL=info

            # Build
            BUILD_TIMESTAMP=$(date +%s)
            EOF

            # Parar container existente
            echo "Parando container existente..."
            docker-compose -f docker-compose.vps.yml down || true

            # âš ï¸ CRÃTICO: Remover TODOS os arquivos .db ANTES do build
            echo "Removendo arquivos .db do cÃ³digo-fonte..."
            find . -name "*.db" -type f ! -path "*/node_modules/*" -delete || true
            find . -name "*.db-*" -type f ! -path "*/node_modules/*" -delete || true
            echo "âœ… Arquivos .db removidos"

            # Limpar TODOS os recursos Docker antigos para garantir rebuild limpo
            echo "Limpando recursos antigos..."
            docker container prune -f || true
            docker image prune -f || true
            docker volume prune -f || true
            docker system prune -af --volumes || true

            # Garantir BUILD_TIMESTAMP como variÃ¡vel de ambiente ANTES do build
            export BUILD_TIMESTAMP=$(date +%s)
            echo "BUILD_TIMESTAMP=${BUILD_TIMESTAMP}"

            # Build da imagem sem cache (BUILD_TIMESTAMP vem do export acima)
            echo "Construindo nova imagem..."
            docker-compose -f docker-compose.vps.yml build --no-cache --pull

            # Iniciar container
            echo "Iniciando container..."
            docker-compose -f docker-compose.vps.yml up -d

            # Aguardar container iniciar
            echo "Aguardando container iniciar..."
            sleep 15

            # Verificar status
            echo "Verificando status do container..."
            docker-compose -f docker-compose.vps.yml ps

            # Verificar logs
            echo "Ãšltimas 50 linhas dos logs:"
            docker-compose -f docker-compose.vps.yml logs --tail=50

            # Verificar health
            echo "Verificando health check..."
            for i in {1..10}; do
              if curl -f http://localhost:3060/health; then
                echo "âœ… DigiUrban estÃ¡ rodando na porta 3060!"
                exit 0
              fi
              echo "Tentativa $i/10 falhou, aguardando 5s..."
              sleep 5
            done

            echo "âš ï¸ Health check falhou apÃ³s 10 tentativas"
            echo "Logs completos:"
            docker-compose -f docker-compose.vps.yml logs
            exit 1

      - name: Verify Deployment
        if: success()
        run: |
          echo "âœ… Deploy concluÃ­do com sucesso!"
          echo "ðŸŒ DigiUrban disponÃ­vel em: https://www.digiurban.com.br"
          echo "ðŸŒ Acesso alternativo: http://72.60.10.108:3060"
          echo "ðŸ“Š Health check: http://72.60.10.108:3060/health"
